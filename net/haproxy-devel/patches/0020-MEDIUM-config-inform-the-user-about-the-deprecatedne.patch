From de9d2d7b86abb0d7110bc3190aca5b26fec6fd64 Mon Sep 17 00:00:00 2001
From: Willy Tarreau <w@1wt.eu>
Date: Mon, 28 Apr 2014 22:28:02 +0200
Subject: [PATCH 20/23] MEDIUM: config: inform the user about the
 deprecatedness of "block" rules

It's just a warning emitted once.
---
 include/types/global.h | 2 +-
 src/cfgparse.c         | 4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/include/types/global.h b/include/types/global.h
index 21433e8..967d3b4 100644
--- a/include/types/global.h
+++ b/include/types/global.h
@@ -173,7 +173,7 @@ extern struct task *global_listener_queue_task;
 extern unsigned int warned;     /* bitfield of a few warnings to emit just once */
 
 /* bit values to go with "warned" above */
-/* #define WARN_* */
+#define WARN_BLOCK_DEPRECATED       0x00000001
 
 /* to be used with warned and WARN_* */
 static inline int already_warned(unsigned int warning)
diff --git a/src/cfgparse.c b/src/cfgparse.c
index f2afcd0..4852059 100644
--- a/src/cfgparse.c
+++ b/src/cfgparse.c
@@ -2896,6 +2896,10 @@ int cfg_parse_listen(const char *file, int linenum, char **args, int kwm)
 	                                          (curproxy->cap & PR_CAP_FE) ? SMP_VAL_FE_HRQ_HDR : SMP_VAL_BE_HRQ_HDR,
 	                                          file, linenum);
 		LIST_ADDQ(&curproxy->block_rules, &rule->list);
+
+		if (!already_warned(WARN_BLOCK_DEPRECATED))
+			Warning("parsing [%s:%d] : The '%s' directive is now deprecated in favor of 'http-request deny' which uses the exact same syntax. The rules are translated but support might disappear in a future version.\n", file, linenum, args[0]);
+
 	}
 	else if (!strcmp(args[0], "redirect")) {
 		struct redirect_rule *rule;
-- 
1.8.3.2

